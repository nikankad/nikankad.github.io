---
import { getCollection, type CollectionEntry } from "astro:content";
import BaseLayout from "../../components/layout/BaseLayout.astro";
import BaseHero from "../../components/shared/BaseHero.astro";
import Container from "../../components/ui/Container.astro";
import ContentList from "../../components/shared/ContentList.astro";

const formatDate = (date: Date | undefined) => {
  if (!date) return "";
  return date.toLocaleDateString("en-US", {
    month: "short",
    year: "numeric",
  });
};

const experiences = await getCollection("experience");
const sortedExperiences = experiences.sort(
  (a: CollectionEntry<"experience">, b: CollectionEntry<"experience">) => {
    const orderA = a.data.order ?? Number.POSITIVE_INFINITY;
    const orderB = b.data.order ?? Number.POSITIVE_INFINITY;
    if (orderA !== orderB) return orderA - orderB;

    // Show current roles first
    if (a.data.current && !b.data.current) return -1;
    if (!a.data.current && b.data.current) return 1;
    // Then sort by start date (most recent first)
    return b.data.startDate.getTime() - a.data.startDate.getTime();
  }
);
---

<BaseLayout title="Experiences" description="Work, programs, and roles Iâ€™ve been part of:">
  <Container>
    <BaseHero title="Experiences" description="" />

    <ContentList>
      {
        sortedExperiences.map((exp) => (
          <article>
            <div class="title-row">
              <div class="company-info">
                <img src={exp.data.logo} alt="" class="company-logo" loading="lazy" />
                <span>{exp.data.title}</span>
              </div>
              <time>
                {formatDate(exp.data.startDate)} - {exp.data.current ? "Present" : formatDate(exp.data.endDate)}
              </time>
            </div>
            <p class="muted-text">{exp.data.description}</p>
          </article>
        ))
      }
    </ContentList>
  </Container>
</BaseLayout>

<style>
  .title-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 1rem;
    font-size: var(--text-sm);
  }

  .company-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .company-logo {
    width: 1.5rem;
    height: 1.5rem;
    object-fit: contain;
  }

  time {
    font-size: var(--text-xs);
    opacity: 0.5;
    white-space: nowrap;
  }
</style>
